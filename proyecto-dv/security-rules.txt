rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /usuarios/{usuario}  {
      allow read: if request.auth != null;
      
      allow create: if 
      	request.auth != null &&
        request.auth.uid == usuario;
    }
    
    match /chat-privado/{chat}  {
    	allow read: if 
            request.auth != null &&
            request.auth.uid in resource.data.usuarios;
        
        allow create: if 
            request.auth != null &&
            request.auth.uid in request.resource.data.usuarios;

        match /mensajes/{mensaje} {
        	allow read: if
          	    request.auth != null &&
                request.auth.uid in get(/databases/$(database)/documents/chat-privado/$(chat)).data.usuarios;
            
            allow create: if
          	    request.auth != null &&
                request.auth.uid in get(/databases/$(database)/documents/chat-privado/$(chat)).data.usuarios &&
                request.auth.uid == request.resource.data.enviaId;
        }
    }
  }
}